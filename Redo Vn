-- Redo VN ESP - NPC | FIXED FULL NPC LIST v1.09-F
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local CoreGui = game:GetService("CoreGui")

local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = "RedoVN_ESP_GUI"
gui.ResetOnSpawn = false

-- Toggle Button
local toggle = Instance.new("TextButton", gui)
toggle.Size = UDim2.new(0, 160, 0, 40)
toggle.Position = UDim2.new(0.02, 0, 0.1, 0)
toggle.Text = "👁️ Redo VN ESP - NPC 🇻🇳"
toggle.TextSize = 16
toggle.TextColor3 = Color3.new(1,1,1)
toggle.BackgroundColor3 = Color3.fromRGB(30,30,30)
toggle.Font = Enum.Font.GothamBold
toggle.Draggable = true
toggle.Active = true

-- Main Frame
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 320, 0, 440)
frame.Position = UDim2.new(0.02, 0, 0.2, 0)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.Visible = true
frame.Active = true
frame.Draggable = true

-- Title
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 40)
title.Text = "🇻🇳 Redo VN ESP - NPC"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.TextSize = 18

-- Credit
local credit = Instance.new("TextLabel", frame)
credit.Size = UDim2.new(1, 0, 0, 20)
credit.Position = UDim2.new(0, 0, 0, 40)
credit.Text = "📌 Made by @RedoVn-y8c | V1.79 update coming soon"
credit.Font = Enum.Font.Gotham
credit.TextColor3 = Color3.fromRGB(255,255,0)
credit.BackgroundTransparency = 1
credit.TextSize = 14

-- Search Box
local searchBox = Instance.new("TextBox", frame)
searchBox.PlaceholderText = "🔍 Search NPC..."
searchBox.Size = UDim2.new(1, -20, 0, 30)
searchBox.Position = UDim2.new(0, 10, 0, 70)
searchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
searchBox.TextColor3 = Color3.new(1, 1, 1)
searchBox.TextSize = 14
searchBox.ClearTextOnFocus = false
searchBox.Font = Enum.Font.Gotham

-- Scroll
local scroll = Instance.new("ScrollingFrame", frame)
scroll.Size = UDim2.new(1, -20, 1, -120)
scroll.Position = UDim2.new(0, 10, 0, 110)
scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
scroll.BackgroundColor3 = Color3.fromRGB(25,25,25)
scroll.ScrollBarThickness = 4
scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
scroll.ClipsDescendants = true

local listLayout = Instance.new("UIListLayout", scroll)
listLayout.Padding = UDim.new(0, 5)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Rainbow
local espColor = Color3.new(0,1,0)
task.spawn(function()
	while true do
		local h = tick() % 5 / 5
		espColor = Color3.fromHSV(h, 1, 1)
		wait(0.1)
	end
end)

local espList = {}
local notified = {}

function createESP(npc)
	if espList[npc] then return end
	local adornee = npc:FindFirstChild("Head") or npc:FindFirstChildWhichIsA("BasePart")
	if not adornee then return end

	local billboard = Instance.new("BillboardGui", npc)
	billboard.Name = "ESP_"..npc.Name
	billboard.Adornee = adornee
	billboard.Size = UDim2.new(0, 200, 0, 30)
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true

	local label = Instance.new("TextLabel", billboard)
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = "- " .. npc.Name
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextStrokeTransparency = 0.6
	label.TextColor3 = espColor

	espList[npc] = billboard
end

function removeESP(npc)
	if espList[npc] then
		espList[npc]:Destroy()
		espList[npc] = nil
	end
end

-- Load NPCs to List
function refreshNPCList()
	scroll:ClearAllChildren()
	listLayout.Parent = scroll

	for _, model in ipairs(workspace:GetDescendants()) do
		if model:IsA("Model") and model:FindFirstChildOfClass("Humanoid") and model ~= LocalPlayer.Character then
			local button = Instance.new("TextButton", scroll)
			button.Size = UDim2.new(1, 0, 0, 30)
			button.Text = model.Name
			button.TextColor3 = Color3.new(1,1,1)
			button.Font = Enum.Font.Gotham
			button.TextSize = 14
			button.BackgroundColor3 = Color3.fromRGB(50,50,50)

			button.MouseButton1Click:Connect(function()
				if espList[model] then
					removeESP(model)
					button.BackgroundColor3 = Color3.fromRGB(50,50,50)
				else
					createESP(model)
					button.BackgroundColor3 = espColor
				end
			end)
		end
	end
end

-- Search
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
	local keyword = searchBox.Text:lower()
	for _, item in pairs(scroll:GetChildren()) do
		if item:IsA("TextButton") then
			item.Visible = item.Text:lower():find(keyword) ~= nil
		end
	end
end)

-- Proximity Alert
RunService.RenderStepped:Connect(function()
	for npc, gui in pairs(espList) do
		if npc and npc:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (npc.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
			if dist >= 30 and dist <= 125 and not notified[npc] then
				notified[npc] = true
				local msg = Instance.new("TextLabel", gui)
				msg.Size = UDim2.new(0.4, 0, 0, 30)
				msg.Position = UDim2.new(0.3, 0, 0, 0)
				msg.Text = "📢 " .. npc.Name .. " gần bạn! ("..math.floor(dist).." studs)"
				msg.Font = Enum.Font.GothamBold
				msg.TextSize = 14
				msg.TextColor3 = Color3.new(1,1,1)
				msg.BackgroundColor3 = Color3.fromRGB(0,0,0)
				wait(3)
				msg:Destroy()
			end
		end
	end
end)

-- Tự động refresh danh sách mỗi 1 giây
task.spawn(function()
	while true do
		refreshNPCList()
		wait(1)
	end
end)

-- Toggle GUI
toggle.MouseButton1Click:Connect(function()
	frame.Visible = not frame.Visible
end)

-- Load lần đầu
refreshNPCList()
